{% extends "layout.html" %}
{% block title %}Acciones en Lote - Ansible Panel{% endblock %}

{% block content %}
<style>
    .device-card { border: 1px solid #dee2e6; transition: all 0.2s ease-in-out; cursor: pointer; }
    .device-card:hover { border-color: #0d6efd; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); }
    .device-card.selected { background-color: #e9f2ff; border-color: #0d6efd; }
    .device-card.error-loading { background-color: #fff0f0; border-color: #e9a0a0; opacity: 0.8; cursor: not-allowed; }
    .action-button { display: flex; align-items: center; gap: 0.5rem; }
    #output-modal-body, .output-console { background-color: #212529; color: #f8f9fa; font-family: monospace; white-space: pre-wrap; max-height: 70vh; overflow-y: auto; }
    .interface-group { border: 1px solid #ddd; border-radius: .25rem; margin-bottom: 1rem; }
    .interface-group .card-header { background-color: #f7f7f7; font-weight: bold; }
    .wifi-label { font-weight: bold; }
    .wifi-label small { font-weight: normal; color: #6c757d; }
</style>

<!-- Título y descripción -->
<div class="d-flex justify-content-between align-items-center mb-4"><h1>Acciones en Lote</h1></div>

<!-- Paso 1: Selección de Dispositivos -->
<div class="card shadow-sm mb-4">
    <div class="card-header"><h5 class="mb-0">Paso 1: Selecciona los Dispositivos</h5></div>
    <div class="card-body">
        <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="select-all-checkbox"><label class="form-check-label fw-bold" for="select-all-checkbox">Seleccionar / Deseleccionar Todos</label></div>
        <div id="devices-container" class="row g-3"><div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Obteniendo lista de dispositivos...</p></div></div>
    </div>
</div>

<!-- Paso 2: Elección de Acción -->
<div class="card shadow-sm">
    <div class="card-header"><h5 class="mb-0">Paso 2: Elige una Acción</h5></div>
    <div class="card-body"><div class="accordion" id="actions-accordion">
        
        <div class="accordion-item"><h2 class="accordion-header" id="heading-interfaces"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-interfaces"><i class="bi bi-diagram-3-fill me-2"></i>Configurar IPs de Interfaces</button></h2><div id="collapse-interfaces" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body"><div id="interfaces-config-container"><p class="text-muted">Selecciona dispositivos para ver sus interfaces.</p></div><button class="btn btn-warning action-button mt-3" data-action="set_interfaces" disabled><i class="bi bi-pencil-fill"></i><span>Aplicar Cambios de IP</span></button></div></div></div>
        
        <div class="accordion-item"><h2 class="accordion-header" id="heading-wifi"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-wifi"><i class="bi bi-wifi me-2"></i>Configurar WiFi (SSID/Contraseña)</button></h2><div id="collapse-wifi" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body"><div id="wifi-config-container"><p class="text-muted">Selecciona dispositivos para ver sus opciones de WiFi.</p></div><button class="btn btn-primary action-button mt-3" data-action="set_wifi" disabled><i class="bi bi-wifi"></i><span>Aplicar Cambios WiFi</span></button></div></div></div>
        
        <div class="accordion-item"><h2 class="accordion-header" id="heading-root"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-root"><i class="bi bi-key-fill me-2"></i>Cambiar Contraseña de Root</button></h2><div id="collapse-root" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body"><p class="text-danger"><strong>¡Atención!</strong> Perderás el acceso si olvidas esta contraseña.</p><form onsubmit="return false;"><div class="col-md-6"><label class="form-label">Nueva Contraseña de Root</label><div class="input-group"><input type="password" class="form-control" name="new_root_password" required><button class="btn btn-outline-secondary password-toggle-btn" type="button"><i class="bi bi-eye-fill"></i></button></div></div></form><button class="btn btn-danger action-button mt-3" data-action="set_root_password" disabled><i class="bi bi-key-fill"></i><span>Cambiar Contraseña</span></button></div></div></div>
        
        <div class="accordion-item"><h2 class="accordion-header" id="heading-reboot"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-reboot"><i class="bi bi-power me-2"></i>Reiniciar Routers</button></h2><div id="collapse-reboot" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body"><p>Esta acción reiniciará completamente los dispositivos seleccionados.</p><button class="btn btn-danger action-button" data-action="reboot" disabled><i class="bi bi-exclamation-triangle-fill"></i><span>Ejecutar Reinicio</span></button></div></div></div>
        
        <div class="accordion-item"><h2 class="accordion-header" id="heading-simple"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-simple"><i class="bi bi-arrow-repeat me-2"></i>Otras Acciones de Reinicio</button></h2><div id="collapse-simple" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body d-flex gap-2"><button class="btn btn-secondary action-button" data-action="restart_network" disabled><i class="bi bi-ethernet"></i><span>Reiniciar Red</span></button></div></div></div>

    </div></div>
</div>

<!-- Modals -->
<div class="modal fade" id="outputModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="outputModalLabel">Resultado</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="output-modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div></div>
<div class="modal fade" id="errorModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title" id="errorModalLabel">Detalles del Error</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>La carga de datos para este dispositivo falló. Esta es la salida completa:</p><pre class="output-console" id="error-output-content"></pre></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (Declaración de constantes igual que antes)
    const devicesContainer = document.getElementById('devices-container');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const actionButtons = document.querySelectorAll('.action-button');
    const outputModal = new bootstrap.Modal(document.getElementById('outputModal'));
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const outputModalBody = document.getElementById('output-modal-body');
    const outputModalTitle = document.getElementById('outputModalLabel');
    const interfacesConfigContainer = document.getElementById('interfaces-config-container');
    const wifiConfigContainer = document.getElementById('wifi-config-container');

    const escapeHTML = (str) => str ? String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]) : '';
    const getWifiStandard = (gen) => ({'Wi-Fi 7':'802.11be','Wi-Fi 6':'802.11ax','Wi-Fi 5':'802.11ac','Wi-Fi 4':'802.11n','Wi-Fi 3':'802.11g','Wi-Fi 2':'802.11a','Legacy':'802.11b'}[gen] || '');
    
    // ... (El resto de funciones auxiliares como addPasswordToggleListeners, toggleActionButtons, etc. se mantienen igual)
    const addPasswordToggleListeners = () => {
        document.querySelectorAll('.password-toggle-btn').forEach(button => {
            if (button.dataset.listenerAttached) return;
            button.dataset.listenerAttached = 'true';
            button.addEventListener('click', function() {
                const input = this.closest('.input-group').querySelector('input');
                input.type = input.type === 'password' ? 'text' : 'password';
                this.querySelector('i').classList.toggle('bi-eye-slash-fill');
            });
        });
    };

    const toggleActionButtons = () => {
        const selectedCount = document.querySelectorAll('.device-card .form-check-input:checked').length;
        document.querySelectorAll('.action-button').forEach(button => {
            button.disabled = (selectedCount === 0);
        });
    };

    // ... (Funciones de creación de tarjetas y carga de datos sin cambios)
    const createDeviceSkeletonCard = (deviceName) => {
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'col-lg-3 col-md-4 col-sm-6';
        cardWrapper.innerHTML = `
            <div class="card device-card h-100" id="card-${deviceName}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${escapeHTML(deviceName)}</h6>
                            <small class="text-muted" id="model-${deviceName}"><div class="spinner-grow spinner-grow-sm" role="status"></div> Cargando...</small>
                        </div>
                        <input class="form-check-input ms-3" type="checkbox" value="${escapeHTML(deviceName)}" disabled>
                    </div>
                    <hr class="my-2">
                    <div style="font-size: 0.85rem;">
                        <div id="ip-${deviceName}" class="mb-1"></div>
                        <div id="radios-${deviceName}"></div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger error-button" style="display: none; position: absolute; bottom: 10px; right: 10px;" data-device-name="${escapeHTML(deviceName)}"><i class="bi bi-bug-fill"></i></button>
                </div>
            </div>`;
        return cardWrapper;
    };

    const populateCardData = async (deviceName) => {
        const card = document.getElementById(`card-${deviceName}`);
        try {
            const response = await fetch(`/api/status/${deviceName}`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }
            const data = await response.json();
            
            card.dataset.deviceData = JSON.stringify(data);
            card.querySelector(`#model-${deviceName}`).textContent = data.model || 'N/A';
            card.querySelector(`#ip-${deviceName}`).innerHTML = `<i class="bi bi-router-fill me-1"></i> ${escapeHTML(data.interfaces?.[0]?.ip || 'N/A')}`;
            
            let radioHtml = '<span class="text-muted small">No radios</span>';
            if (data.radios && data.radios.length > 0) {
                radioHtml = data.radios.map(r => {
                    const standard = getWifiStandard(r.generation);
                    const displayText = standard ? `${escapeHTML(r.name)} (${standard} - ${escapeHTML(r.generation)})` : `${escapeHTML(r.name)} (${escapeHTML(r.generation)})`;
                    return `<div class="radio-info" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${displayText}</div>`;
                }).join('');
            }
            card.querySelector(`#radios-${deviceName}`).innerHTML = `<i class="bi bi-wifi me-1"></i> ${radioHtml}`;
            card.querySelector('.form-check-input').disabled = false;
        } catch (error) {
            card.classList.add('error-loading');
            let errorData;
            try { errorData = JSON.parse(error.message); } catch (e) { errorData = { error: "Error de comunicación o parseo." }; }
            card.querySelector(`#model-${deviceName}`).innerHTML = `<span class="text-danger">${escapeHTML(errorData.error || "Error de carga")}</span>`;
            const errorButton = card.querySelector('.error-button');
            if (errorData.ansible_stdout || errorData.ansible_stderr) {
                errorButton.style.display = 'block';
                errorButton.dataset.errorOutput = `STDOUT:\n${errorData.ansible_stdout || ''}\n\nSTDERR:\n${errorData.ansible_stderr || ''}`;
            }
        }
    };
    
    const loadAllDevices = async () => {
        devicesContainer.innerHTML = '<div class="text-center p-5 col-12"><div class="spinner-border text-primary"></div><p class="mt-2">Obteniendo lista de dispositivos...</p></div>';
        try {
            const response = await fetch('/api/devices');
            const deviceNames = await response.json();
            devicesContainer.innerHTML = '';
            if (!deviceNames || deviceNames.length === 0) { 
                devicesContainer.innerHTML = '<p class="text-center col-12">No hay dispositivos en el inventario.</p>'; 
                return;
            }
            deviceNames.forEach(name => devicesContainer.appendChild(createDeviceSkeletonCard(name)));
            await Promise.all(deviceNames.map(name => populateCardData(name)));
        } catch (error) {
            console.error("Error fatal al cargar dispositivos:", error);
            devicesContainer.innerHTML = '<p class="text-danger text-center col-12">Error fatal al cargar la lista de dispositivos. Revisa la consola (F12).</p>';
        }
    };
    
    const updateActionForms = () => {
        const selectedDevicesData = Array.from(document.querySelectorAll('.device-card .form-check-input:checked'))
            .map(cb => {
                const data = cb.closest('.device-card').dataset.deviceData;
                try { return data ? JSON.parse(data) : null; } catch(e) { return null; }
            })
            .filter(d => d && d.status === 'online');
        updateInterfacesUI(selectedDevicesData);
        updateWifiUI(selectedDevicesData);
    };

    const updateInterfacesUI = (devicesData) => {
        if (devicesData.length === 0) {
            interfacesConfigContainer.innerHTML = '<p class="text-muted">Selecciona dispositivos online para ver sus interfaces.</p>';
            return;
        }

        let html = '';
        devicesData.forEach(device => {
            if (!device.interfaces || device.interfaces.length === 0) return;
            html += `<div class="card interface-group"><div class="card-header">${escapeHTML(device.hostname)}</div><div class="card-body">`;
            device.interfaces.forEach(iface => {
                html += `
                    <div class="row g-3 align-items-center mb-2">
                        <div class="col-lg-3 col-md-12"><strong><i class="bi bi-ethernet text-primary"></i> ${escapeHTML(iface.name)}</strong></div>
                        <div class="col-lg-5 col-md-6"><input type="text" class="form-control form-control-sm iface-input" data-device="${escapeHTML(device.inventory_name)}" data-iface-name="${escapeHTML(iface.name)}" data-field="ip" value="${escapeHTML(iface.ip)}" placeholder="Dirección IP"></div>
                        <div class="col-lg-4 col-md-6"><input type="text" class="form-control form-control-sm iface-input" data-device="${escapeHTML(device.inventory_name)}" data-iface-name="${escapeHTML(iface.name)}" data-field="mask" value="${escapeHTML(iface.mask)}" placeholder="Máscara de red"></div>
                    </div>`;
            });
            html += '</div></div>';
        });
        interfacesConfigContainer.innerHTML = html || '<p>Los dispositivos seleccionados no tienen interfaces configurables.</p>';
    };

    const updateWifiUI = (devicesData) => {
        if (devicesData.length === 0) {
            wifiConfigContainer.innerHTML = '<p class="text-muted">Selecciona dispositivos online para ver sus opciones de WiFi.</p>';
            return;
        }
        const ENCRYPTION_OPTIONS_FLATTENED = [
            { label: 'WPA3 (Recomendado)', options: [{ value: 'sae', text: 'WPA3 Personal (SAE)', aliases: ['sae'] },{ value: 'sae-mixed', text: 'WPA2/WPA3 Mixto', aliases: ['sae-mixed'] }] },
            { label: 'WPA2 (Seguro)', options: [{ value: 'psk2', text: 'WPA2-PSK (AES)', aliases: ['psk2', 'psk2+ccmp', 'psk2+aes'] },{ value: 'psk2+tkip', text: 'WPA2-PSK (TKIP)', aliases: ['psk2+tkip'] },{ value: 'psk2+tkip+ccmp', text: 'WPA2-PSK (TKIP+AES)', aliases: ['psk2+tkip+ccmp', 'psk2+tkip+aes'] }] },
            { label: 'WPA/WPA2 Mixto', options: [{ value: 'psk-mixed', text: 'WPA/WPA2-PSK (AES)', aliases: ['psk-mixed', 'psk-mixed+ccmp', 'psk-mixed+aes'] },{ value: 'psk-mixed+tkip', text: 'WPA/WPA2-PSK (TKIP)', aliases: ['psk-mixed+tkip'] },{ value: 'psk-mixed+tkip+ccmp', text: 'WPA/WPA2-PSK (TKIP+AES)', aliases: ['psk-mixed+tkip+ccmp', 'psk-mixed+tkip+aes'] }] },
            { label: 'Legacy y Abiertas', options: [{ value: 'wep-open', text: 'WEP (Inseguro)', aliases: ['wep', 'wep-open'] },{ value: 'wep-shared', text: 'WEP Shared Key', aliases: ['wep-shared'] },{ value: 'owe', text: 'OWE (Enhanced Open)', aliases: ['owe'] },{ value: 'none', text: 'OPEN (Sin Seguridad)', aliases: ['none'] }] }
        ];
        let html = '';
        devicesData.forEach(device => {
            if (!device.radios || device.radios.length === 0) return;
            html += `<div class="card interface-group"><div class="card-header">${escapeHTML(device.hostname)}</div><div class="card-body">`;
            device.radios.forEach(radio => {
                const standard = getWifiStandard(radio.generation);
                const displayText = standard ? `${escapeHTML(standard)} - ${escapeHTML(radio.generation)}` : escapeHTML(radio.generation);
                
                let optionsHtml = ENCRYPTION_OPTIONS_FLATTENED.map(group => {
                    let groupOptions = group.options
                        // ====================== ¡ESTA ES LA LÍNEA ELIMINADA! ======================
                        // Se ha eliminado la línea .filter(...) que causaba el problema.
                        // Ahora, todas las opciones se renderizan siempre.
                        // =========================================================================
                        .map(option => {
                            // Esta lógica, que SELECCIONA la opción correcta, sí funciona.
                            // Comprueba si el cifrado actual del router (ej: 'psk2') está en la lista de alias de la opción.
                            const isSelected = option.aliases.includes(radio.encryption);
                            return `<option value="${option.value}" ${isSelected ? 'selected' : ''}>${option.text}</option>`;
                        }).join('');
                    // Solo mostramos el grupo si contenía alguna opción
                    return groupOptions ? `<optgroup label="${group.label}">${groupOptions}</optgroup>` : '';
                }).join('');

                html += `<div class="row g-3 align-items-center mb-3">
                        <div class="col-lg-3 col-md-12 wifi-label">
                            <i class="bi bi-wifi text-primary"></i> ${escapeHTML(radio.name)}<br><small>${displayText}</small>
                        </div>
                        <div class="col-lg-3 col-md-4"><input type="text" class="form-control form-control-sm wifi-input" data-device="${escapeHTML(device.inventory_name)}" data-radio-index="${escapeHTML(radio.index)}" data-field="ssid" value="${escapeHTML(radio.ssid)}" placeholder="SSID"></div>
                        <div class="col-lg-3 col-md-4"><div class="input-group input-group-sm"><input type="password" class="form-control form-control-sm wifi-input" data-device="${escapeHTML(device.inventory_name)}" data-radio-index="${escapeHTML(radio.index)}" data-field="key" value="${escapeHTML(radio.key)}" placeholder="Contraseña"><button class="btn btn-outline-secondary password-toggle-btn" type="button"><i class="bi bi-eye-fill"></i></button></div></div>
                        <div class="col-lg-3 col-md-4"><select class="form-select form-select-sm wifi-input" data-device="${escapeHTML(device.inventory_name)}" data-radio-index="${escapeHTML(radio.index)}" data-field="encryption">${optionsHtml}</select></div>
                    </div>`;
            });
            html += '</div></div>';
        });
        wifiConfigContainer.innerHTML = html || '<p>Los dispositivos seleccionados no tienen radios WiFi.</p>';
        addPasswordToggleListeners();
    };

    // ... (El resto de funciones como executeAction, showErrorModal y los event listeners se mantienen sin cambios)
    const executeAction = async (e) => {
        const button = e.currentTarget;
        const action = button.dataset.action;
        const targets = Array.from(document.querySelectorAll('.device-card .form-check-input:checked')).map(cb => cb.value);

        if (targets.length === 0) {
            alert("Por favor, selecciona al menos un dispositivo.");
            return;
        }

        let params = {};
        if (action === 'set_interfaces') {
            params.changes = [];
            document.querySelectorAll('.iface-input[data-field="ip"]').forEach(ipInput => {
                const device = ipInput.dataset.device;
                const iface_name = ipInput.dataset.ifaceName;
                const ip = ipInput.value;
                const mask = document.querySelector(`.iface-input[data-device="${device}"][data-iface-name="${iface_name}"][data-field="mask"]`).value;
                params.changes.push({ device, iface_name, ip, mask });
            });
        } else if (action === 'set_wifi') {
            params.changes = [];
            document.querySelectorAll('.wifi-input[data-field="ssid"]').forEach(ssidInput => {
                const device = ssidInput.dataset.device;
                const index = ssidInput.dataset.radioIndex;
                const ssid = ssidInput.value;
                const key = document.querySelector(`.wifi-input[data-device="${device}"][data-radio-index="${index}"][data-field="key"]`).value;
                const encryption = document.querySelector(`.wifi-input[data-device="${device}"][data-radio-index="${index}"][data-field="encryption"]`).value;
                params.changes.push({ device, index, ssid, key, encryption });
            });
        } else if (action === 'set_root_password') {
            const passwordInput = document.querySelector('input[name="new_root_password"]');
            params.new_root_password = passwordInput.value;
            if (!params.new_root_password) { alert("La nueva contraseña no puede estar vacía."); return; }
        }

        const confirmed = confirm(`¿Estás seguro de que quieres ejecutar la acción '${action}' en ${targets.length} dispositivo(s)?`);
        if (!confirmed) return;

        button.disabled = true;
        button.querySelector('span').textContent = 'Ejecutando...';

        try {
            const response = await fetch('/api/execute_batch_action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content') },
                body: JSON.stringify({ action, targets, params })
            });
            const result = await response.json();
            outputModalTitle.textContent = `Resultado de la Acción: ${action}`;
            outputModalBody.innerHTML = `<strong>Salida Estándar:</strong><pre class="output-console">${escapeHTML(result.output) || 'Sin salida.'}</pre>`;
            if (result.error) {
                outputModalBody.innerHTML += `<hr><strong>Errores:</strong><pre class="output-console text-danger">${escapeHTML(result.error)}</pre>`;
            }
            outputModal.show();
        } catch (err) {
            outputModalTitle.textContent = 'Error de Ejecución';
            outputModalBody.textContent = `Error al contactar con el servidor: ${err}`;
            outputModal.show();
        } finally {
            button.disabled = false;
            button.querySelector('span').textContent = button.textContent.trim().split(' ').slice(1).join(' ');
        }
    };
    
    const showErrorModal = (button) => {
        document.getElementById('error-output-content').textContent = button.dataset.errorOutput || "No hay detalles de error disponibles.";
        errorModal.show();
    };

    devicesContainer.addEventListener('click', (e) => {
        const errorButton = e.target.closest('.error-button');
        if (errorButton) { showErrorModal(errorButton); return; }
        
        const card = e.target.closest('.device-card');
        if (!card || card.classList.contains('error-loading')) return;
        
        const checkbox = card.querySelector('.form-check-input');
        if (e.target.tagName !== 'INPUT') checkbox.checked = !checkbox.checked;
        
        card.classList.toggle('selected', checkbox.checked);
        toggleActionButtons();
        updateActionForms();
    });

    selectAllCheckbox.addEventListener('change', () => {
        document.querySelectorAll('.device-card .form-check-input:not(:disabled)').forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
            cb.closest('.device-card').classList.toggle('selected', cb.checked);
        });
        toggleActionButtons();
        updateActionForms();
    });

    actionButtons.forEach(btn => btn.addEventListener('click', executeAction));
    
    loadAllDevices();
});
</script>
{% endblock %}
