{% extends "layout.html" %}
{% block title %}Acciones en Lote - Ansible Panel{% endblock %}

{% block content %}
<style>
    .device-card { border: 1px solid #dee2e6; transition: all 0.2s ease-in-out; }
    .device-card:hover { border-color: #0d6efd; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); }
    .device-card.selected { background-color: #e9f2ff; border-color: #0d6efd; }
    .device-card.error-loading { background-color: #fff0f0; border-color: #e9a0a0; opacity: 0.7; }
    .device-card .form-check-input { transform: scale(1.5); }
    .action-button { display: flex; align-items: center; gap: 0.5rem; }
    #output-modal-body { background-color: #212529; color: #f8f9fa; font-family: monospace; white-space: pre-wrap; max-height: 70vh; }
    .input-group .btn { border-color: #dee2e6; }
    #wifi-config-container .card { background-color: #f8f9fa; }
</style>

<!-- Título y descripción -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Acciones en Lote</h1>
        <p class="text-muted">Selecciona los dispositivos y elige una acción para ejecutar en todos ellos.</p>
    </div>
</div>

<!-- Paso 1: Selección de Dispositivos -->
<div class="card shadow-sm mb-4">
    <div class="card-header"><h5 class="mb-0">Paso 1: Selecciona los Dispositivos</h5></div>
    <div class="card-body">
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" value="" id="select-all-checkbox">
            <label class="form-check-label fw-bold" for="select-all-checkbox">Seleccionar / Deseleccionar Todos</label>
        </div>
        <div id="devices-container" class="row g-3">
            <div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Obteniendo lista de dispositivos...</p></div>
        </div>
    </div>
</div>

<!-- Paso 2: Elección de Acción -->
<div class="card shadow-sm">
    <div class="card-header"><h5 class="mb-0">Paso 2: Elige una Acción</h5></div>
    <div class="card-body">
        <div class="accordion" id="actions-accordion">
             <!-- Acción: Reiniciar Sistema -->
             <div class="accordion-item"><h2 class="accordion-header" id="heading-reboot"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-reboot"><i class="bi bi-power me-2"></i>Reiniciar Routers</button></h2><div id="collapse-reboot" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body"><p>Esta acción reiniciará completamente los dispositivos seleccionados.</p><button class="btn btn-danger action-button" data-action="reboot" disabled><i class="bi bi-exclamation-triangle-fill"></i><span>Ejecutar Reinicio</span></button></div></div></div>
             <!-- Acción: Cambiar IPv4 LAN -->
             <div class="accordion-item"><h2 class="accordion-header" id="heading-ipv4"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-ipv4"><i class="bi bi-diagram-3 me-2"></i>Cambiar Configuración IPv4 (LAN)</button></h2><div id="collapse-ipv4" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body"><p class="text-muted">Deja un campo en blanco para no modificar su valor actual.</p<form class="row g-3" onsubmit="return false;"><div class="col-md-4"><label class="form-label">Nueva IP</label><input type="text" class="form-control" name="new_ip" placeholder="Ej: 192.168.1.1"></div><div class="col-md-4"><label class="form-label">Nueva Máscara de Red</label><input type="text" class="form-control" name="new_mask" placeholder="Ej: 255.255.255.0"></div><div class="col-md-4"><label class="form-label">Nuevo Gateway</label><input type="text" class="form-control" name="new_gateway" placeholder="Ej: 192.168.1.1"></div></form><button class="btn btn-warning action-button mt-3" data-action="set_ipv4" disabled><i class="bi bi-pencil-fill"></i><span>Aplicar Cambios de Red</span></button></div></div></div>
            <!-- Acción: Cambiar WiFi (Contenedor dinámico) -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-wifi"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-wifi"><i class="bi bi-wifi me-2"></i>Cambiar SSID, Cifrado y Contraseña</button></h2>
                <div id="collapse-wifi" class="accordion-collapse collapse" data-bs-parent="#actions-accordion">
                    <div class="accordion-body">
                        <div id="wifi-config-container">
                            <p class="text-muted">Selecciona uno o más dispositivos para ver las opciones de configuración de WiFi.</p>
                        </div>
                        <button class="btn btn-primary action-button mt-3" data-action="set_wifi" disabled><i class="bi bi-wifi"></i><span>Aplicar Cambios WiFi</span></button>
                    </div>
                </div>
            </div>
             <!-- Acción: Cambiar Contraseña Root -->
             <div class="accordion-item"><h2 class="accordion-header" id="heading-root"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-root"><i class="bi bi-key-fill me-2"></i>Cambiar Contraseña de Root</button></h2><div id="collapse-root" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body"><p class="text-danger"><strong>¡Atención!</strong> Perderás el acceso si olvidas esta contraseña.</p><form class="row g-3" onsubmit="return false;"><div class="col-md-6"><label class="form-label">Nueva Contraseña de Root</label><div class="input-group"><input type="password" class="form-control" name="new_root_password" required><button class="btn btn-outline-secondary password-toggle-btn" type="button"><i class="bi bi-eye-fill"></i></button></div></div></form><button class="btn btn-danger action-button mt-3" data-action="set_root_password" disabled><i class="bi bi-key-fill"></i><span>Cambiar Contraseña</span></button></div></div></div>
             <!-- Acciones Simples -->
             <div class="accordion-item"><h2 class="accordion-header" id="heading-simple"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-simple"><i class="bi bi-arrow-repeat me-2"></i>Otras Acciones de Reinicio</button></h2><div id="collapse-simple" class="accordion-collapse collapse" data-bs-parent="#actions-accordion"><div class="accordion-body d-flex gap-2"><button class="btn btn-secondary action-button" data-action="restart_network" disabled><i class="bi bi-ethernet"></i><span>Reiniciar Red</span></button><button class="btn btn-secondary action-button" data-action="restart_wifi" disabled><i class="bi bi-wifi-off"></i><span>Reiniciar WiFi</span></button></div></div></div>
        </div>
    </div>
</div>

<!-- Modal para mostrar la salida -->
<div class="modal fade" id="outputModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="outputModalLabel">Resultado</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="output-modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const devicesContainer = document.getElementById('devices-container');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const actionButtons = document.querySelectorAll('.action-button');
    const outputModal = new bootstrap.Modal(document.getElementById('outputModal'));
    const outputModalBody = document.getElementById('output-modal-body');
    const outputModalTitle = document.getElementById('outputModalLabel');
    const wifiConfigContainer = document.getElementById('wifi-config-container');

    const createDeviceSkeletonCard = (deviceName) => {
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'col-lg-3 col-md-4 col-sm-6';
        const card = document.createElement('div');
        card.className = 'card device-card h-100';
        card.id = `card-${deviceName}`;
        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-1">${deviceName}</h6>
                        <small class="text-muted" id="model-${deviceName}">Cargando modelo...</small>
                    </div>
                    <input class="form-check-input ms-3" type="checkbox" value="${deviceName}" disabled>
                </div>
                <hr class="my-2">
                <div style="font-size: 0.9rem;">
                    <div id="ip-${deviceName}"><i class="bi bi-router-fill me-2"></i> Cargando IP...</div>
                    <div class="mt-1" id="radios-${deviceName}"><i class="bi bi-wifi me-2"></i> Cargando radios...</div>
                </div>
            </div>
        `;
        cardWrapper.appendChild(card);
        return cardWrapper;
    };

    const populateCardData = async (deviceName) => {
        const card = document.getElementById(`card-${deviceName}`);
        try {
            const response = await fetch(`/api/status/${deviceName}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Respuesta no válida');
            }
            const data = await response.json();
            card.dataset.deviceData = JSON.stringify(data);
            document.getElementById(`model-${deviceName}`).textContent = data.model || 'N/A';
            document.getElementById(`ip-${deviceName}`).innerHTML = `<i class="bi bi-router-fill me-2"></i> ${data.ip || 'N/A'}`;
            let radioHtml = '<span class="text-muted">No radios</span>';
            if (data.radios && data.radios.length > 0) {
                radioHtml = data.radios.map(r => {
                    const match = r.generation.match(/Wi-Fi (\d+)/);
                    const shortGen = match ? `-WIFI${match[1]}` : '';
                    return `<span class="badge bg-primary me-1">${r.name}${shortGen}</span>`;
                }).join('');
            }
            document.getElementById(`radios-${deviceName}`).innerHTML = `<i class="bi bi-wifi me-2"></i> ${radioHtml}`;
            card.querySelector('.form-check-input').disabled = false;
        } catch (error) {
            card.classList.add('error-loading');
            document.getElementById(`model-${deviceName}`).innerHTML = `<span class="text-danger">${error.message}</span>`;
            document.getElementById(`ip-${deviceName}`).innerHTML = '';
            document.getElementById(`radios-${deviceName}`).innerHTML = '';
        }
    };
    
    const loadAllDevices = async () => {
        try {
            const response = await fetch('/api/devices');
            const deviceNames = await response.json();
            devicesContainer.innerHTML = '';
            if (deviceNames.length === 0) {
                devicesContainer.innerHTML = '<p class="text-center col-12">No se encontraron dispositivos en el inventario.</p>';
                return;
            }
            deviceNames.forEach(name => {
                devicesContainer.appendChild(createDeviceSkeletonCard(name));
            });
            deviceNames.forEach(name => {
                populateCardData(name);
            });
        } catch (error) {
            devicesContainer.innerHTML = '<p class="text-danger text-center col-12">Error fatal al cargar la lista de dispositivos.</p>';
        }
    };

    const updateWifiConfigUI = async () => {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.device-card .form-check-input:checked'));
        wifiConfigContainer.innerHTML = '';

        if (selectedCheckboxes.length === 0) {
            wifiConfigContainer.innerHTML = '<p class="text-muted">Selecciona uno o más dispositivos para ver las opciones.</p>';
            return;
        }

        const selectedDevicesData = selectedCheckboxes.map(cb => {
            const data = cb.closest('.device-card').dataset.deviceData;
            return data ? JSON.parse(data) : null;
        }).filter(Boolean);

        if (selectedDevicesData.length !== selectedCheckboxes.length) {
            wifiConfigContainer.innerHTML = '<p class="text-warning">Algunos de los dispositivos seleccionados aún no han cargado sus datos. Espere...</p>';
            return;
        }

        const firstDeviceRadios = selectedDevicesData[0].radios.map(r => r.index);
        const commonRadioIndices = firstDeviceRadios.filter(radioIndex => 
            selectedDevicesData.every(dev => dev.radios.some(r => r.index === radioIndex))
        );

        if (commonRadioIndices.length === 0) {
            wifiConfigContainer.innerHTML = '<p class="text-warning">Los dispositivos seleccionados no tienen radios WiFi en común.</p>';
            return;
        }

        const cipherMap = {
            'WPA3': { text: 'WPA3-SAE', value: 'sae-mixed' },
            'WPA2': { text: 'WPA2-PSK', value: 'psk2+ccmp' },
            'WPA': { text: 'WPA-PSK (Mixto)', value: 'psk-mixed+ccmp' },
            'WEP': { text: 'WEP (Inseguro)', value: 'wep-open' },
            'OPEN': { text: 'Abierta (Sin cifrado)', value: 'none' }
        };

        for (const index of commonRadioIndices) {
            const radioInfo = selectedDevicesData[0].radios.find(r => r.index === index);

            let commonCiphers = radioInfo.supported_ciphers;
            for (let i = 1; i < selectedDevicesData.length; i++) {
                const deviceRadio = selectedDevicesData[i].radios.find(r => r.index === index);
                commonCiphers = commonCiphers.filter(c => deviceRadio.supported_ciphers.includes(c));
            }
            
            let cipherOptionsHtml = '';
            for (const cipherKey in cipherMap) {
                if (commonCiphers.includes(cipherKey)) {
                    cipherOptionsHtml += `<option value="${cipherMap[cipherKey].value}">${cipherMap[cipherKey].text}</option>`;
                }
            }
            if (!cipherOptionsHtml) {
                cipherOptionsHtml = '<option disabled>No hay cifrados comunes</option>';
            }

            const radioCard = document.createElement('div');
            radioCard.className = 'card mb-3';
            radioCard.innerHTML = `
                <div class="card-header fw-bold">Radio ${radioInfo.index} (${radioInfo.generation})</div>
                <div class="card-body">
                    <form class="row g-3" onsubmit="return false;" data-radio-index="${index}">
                        <div class="col-md-5"><label class="form-label">SSID</label><input type="text" class="form-control" name="ssid_${index}" placeholder="Nombre de la red"></div>
                        <div class="col-md-4"><label class="form-label">Contraseña</label><div class="input-group"><input type="password" class="form-control" name="password_${index}" placeholder="Mín. 8 caracteres"><button class="btn btn-outline-secondary password-toggle-btn" type="button"><i class="bi bi-eye-fill"></i></button></div></div>
                        <div class="col-md-3"><label class="form-label">Cifrado</label><select class="form-select" name="encryption_${index}">${cipherOptionsHtml}</select></div>
                    </form>
                </div>
            `;
            wifiConfigContainer.appendChild(radioCard);
        }
        
        if (selectedDevicesData.length === 1) {
            const device = selectedDevicesData[0];
            for (const radio of device.radios) {
                const form = wifiConfigContainer.querySelector(`form[data-radio-index="${radio.index}"]`);
                if(form) {
                    form.querySelector(`[name="ssid_${radio.index}"]`).value = radio.ssid;
                    try {
                        const response = await fetch(`/api/wifi_details/${device.hostname}/${radio.index}`);
                        const wifiDetails = await response.json();
                        if (wifiDetails.password) form.querySelector(`[name="password_${radio.index}"]`).value = wifiDetails.password;
                        if (wifiDetails.encryption) form.querySelector(`[name="encryption_${radio.index}"]`).value = wifiDetails.encryption;
                    } catch (e) { console.error(`Error fetching wifi details for ${device.hostname} radio ${radio.index}`); }
                }
            }
        }
        addPasswordToggleListeners();
    };
    
    const addPasswordToggleListeners = () => {
        document.querySelectorAll('.password-toggle-btn').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.closest('.input-group').querySelector('input');
                const icon = this.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.replace('bi-eye-fill', 'bi-eye-slash-fill');
                } else {
                    input.type = 'password';
                    icon.classList.replace('bi-eye-slash-fill', 'bi-eye-fill');
                }
            });
        });
    };

    const toggleActionButtons = () => {
        const anySelected = document.querySelectorAll('.device-card .form-check-input:checked').length > 0;
        actionButtons.forEach(btn => btn.disabled = !anySelected);
    };

    const handleDeviceSelection = (e) => {
        if (e.target.classList.contains('form-check-input')) {
            e.target.closest('.device-card').classList.toggle('selected', e.target.checked);
            toggleActionButtons();
            updateWifiConfigUI();
        }
    };
    
    selectAllCheckbox.addEventListener('change', () => {
        document.querySelectorAll('.device-card .form-check-input:not(:disabled)').forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
            cb.closest('.device-card').classList.toggle('selected', cb.checked);
        });
        toggleActionButtons();
        updateWifiConfigUI();
    });

    const executeAction = async (e) => {
        const button = e.currentTarget;
        const action = button.dataset.action;
        const actionContainer = button.closest('.accordion-body');
        
        const selectedDevicesNames = Array.from(document.querySelectorAll('.device-card .form-check-input:checked')).map(cb => cb.value);
        if (selectedDevicesNames.length === 0) return;

        let params = {};
        if (action === 'set_wifi') {
            params.radios = [];
            const forms = actionContainer.querySelectorAll('#wifi-config-container form');
            for (const form of forms) {
                const index = form.dataset.radioIndex;
                const ssid = form.querySelector(`[name="ssid_${index}"]`).value;
                const password = form.querySelector(`[name="password_${index}"]`).value;
                const encryption = form.querySelector(`[name="encryption_${index}"]`).value;
                if (!ssid) {
                    alert(`El SSID es obligatorio para la Radio ${index}.`);
                    return;
                }
                if (encryption !== 'none' && password.length < 8) {
                    alert(`Para la Radio ${index}, la contraseña debe tener al menos 8 caracteres para cifrados seguros.`);
                    return;
                }
                params.radios.push({ index, ssid, password, encryption });
            }
        } else {
            const form = actionContainer.querySelector('form');
            if (form) {
                if (!form.checkValidity()) { form.reportValidity(); return; }
                const formData = new FormData(form);
                for (let [key, value] of formData.entries()) {
                    if (value) params[key] = value;
                }
            }
        }
        
        button.disabled = true;
        button.querySelector('span').textContent = 'Ejecutando...';

        outputModalTitle.textContent = `Resultado: ${action}`;
        outputModalBody.innerHTML = 'Enviando comando...';
        outputModal.show();
        
        try {
            const response = await fetch('/api/execute_batch_action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, targets: selectedDevicesNames, params })
            });
            const result = await response.json();
            let html = `<h4>Salida:</h4><pre>${result.output || ''}</pre>`;
            if (result.error) html += `<h4 class="text-danger mt-3">Errores:</h4><pre class="text-danger">${result.error}</pre>`;
            outputModalBody.innerHTML = html;
        } catch (error) {
            outputModalBody.innerHTML = `<h4 class="text-danger">Error de comunicación</h4><pre>${error}</pre>`;
        } finally {
            button.disabled = false;
            // Reconstruye el texto original del span
            const originalTextMap = { 'set_wifi': 'Aplicar Cambios WiFi', 'reboot': 'Ejecutar Reinicio', 'set_ipv4': 'Aplicar Cambios de Red', 'set_root_password': 'Cambiar Contraseña', 'restart_network': 'Reiniciar Red', 'restart_wifi': 'Reiniciar WiFi' };
            button.querySelector('span').textContent = originalTextMap[action] || 'Ejecutar';
        }
    };
    
    devicesContainer.addEventListener('change', handleDeviceSelection);
    actionButtons.forEach(btn => btn.addEventListener('click', executeAction));
    
    loadAllDevices();
});
</script>
{% endblock %}
