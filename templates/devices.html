{% extends "layout.html" %}
{% block content %}
<style>
  /* --- Estilos Generales de la Tarjeta --- */
  .cards-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; }
  .card { border: 1px solid #ccc; border-radius: 8px; padding: 16px; width: 320px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-color: #f9f9f9; position: relative; transition: all 0.3s ease; display: flex; flex-direction: column; }
  .card.status-offline { background-color: #fff0f0; border-color: #e9a0a0; }
  .card h3 { margin-top: 0; padding-bottom: 10px; display: flex; align-items: center; font-size: 1.1rem; border-bottom: 1px solid #eee; margin-bottom: 1rem;}
  .card .card-body { flex-grow: 1; }
  .card .card-footer { font-size: 0.9rem; color: #6c757d; border-top: 1px solid #eee; padding-top: 10px; margin-top: auto; }
  
  /* --- Estilos para la Lista de Información (en tarjetas y modal) --- */
  .info-list { font-size: 0.9rem; }
  .info-list dt { /* Esta es nuestra "etiqueta/badge" azul */
    font-weight: bold;
    color: #0d6efd; /* Color azul de Bootstrap */
    font-size: 0.75rem;
    text-transform: uppercase;
    margin-top: 0.5rem;
  }
  .info-list dd { /* Este es el valor */
    font-weight: 500;
    margin-left: 0; /* Reseteamos el margen por defecto */
    margin-bottom: 0.8rem;
    word-wrap: break-word; 
  }

  /* --- Iconos y Estados --- */
  .status-icon { width: 15px; height: 15px; border-radius: 50%; margin-right: 10px; display: inline-block; flex-shrink: 0;}
  .status-icon.pending { background-color: #ccc; animation: pulse 1.5s infinite; }
  .status-icon.online { background-color: #28a745; }
  .status-icon.offline { background-color: #dc3545; }
  #refresh-button { margin-bottom: 20px; }
  .info-button { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 1.2rem; }
  
  /* --- Estilos específicos del Modal --- */
  .modal-body h5 {
    color: #0d6efd;
    border-bottom: 2px solid #0d6efd;
    padding-bottom: 5px;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }
  .modal-body h5:first-child { margin-top: 0; }
  .dmesg-log { background-color: #212529; color: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
  @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
</style>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>Estado de los Dispositivos</h2>
    <button id="refresh-button" class="btn btn-primary"><i class="bi bi-arrow-clockwise"></i> Refrescar</button>
</div>

<div id="cards-container" class="cards-container"></div>

<!-- Modal Structure -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"> <!-- Añadido scrollable por si el contenido es muy largo -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">Detalles del Dispositivo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('cards-container');
    const refreshButton = document.getElementById('refresh-button');
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    const modalBody = infoModal._element.querySelector('.modal-body');
    const modalTitle = infoModal._element.querySelector('.modal-title');

    const createDeviceCard = (deviceName) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${deviceName}`;
        card.innerHTML = `
            <i class="bi bi-info-circle-fill info-button" data-device-name="${deviceName}" style="display: none;"></i>
            <h3><span id="status-icon-${deviceName}" class="status-icon pending"></span>${deviceName}</h3>
            <div class="card-body">
                <dl class="info-list">
                    <dt>Hostname</dt>
                    <dd id="hostname-${deviceName}">Cargando...</dd>
                    <dt>Modelo</dt>
                    <dd id="model-${deviceName}">Cargando...</dd>
                    <dt>Firmware</dt>
                    <dd id="firmware-short-${deviceName}">Cargando...</dd>
                </dl>
            </div>
            <div class="card-footer">
                <strong>IP:</strong> <span id="ip-${deviceName}">Cargando...</span>
            </div>
        `;
        return card;
    };

    const updateCardStatus = async (deviceName) => {
        const card = document.getElementById(`card-${deviceName}`);
        const statusIcon = document.getElementById(`status-icon-${deviceName}`);
        const infoButton = card.querySelector('.info-button');

        try {
            const response = await fetch(`/api/status/${deviceName}`);
            if (!response.ok) {
                const errorData = await response.json();
                // --- INICIO DE LA MODIFICACIÓN ---
                // Priorizamos el mensaje de error amigable que nos manda el backend.
                const errorMessage = errorData.error || errorData.details || 'Respuesta no OK del servidor';
                throw new Error(errorMessage);
                // --- FIN DE LA MODIFICACIÓN ---
            }
            const data = await response.json();
            statusIcon.classList.remove('pending');

            if (data.status === 'online') {
                card.classList.remove('status-offline');
                card.classList.add('status-online');
                statusIcon.classList.add('online');
                infoButton.style.display = 'block';
                infoButton.dataset.deviceData = JSON.stringify(data);

                document.getElementById(`hostname-${deviceName}`).textContent = data.hostname || 'N/A';
                document.getElementById(`model-${deviceName}`).textContent = data.model || 'N/A';
                document.getElementById(`ip-${deviceName}`).textContent = data.ip || 'N/A';
                
                let shortFirmware = 'N/A';
                if (data.firmware) {
                    const match = data.firmware.match(/^(.*?)\s*r\d+/);
                    shortFirmware = match ? match[1].trim() : data.firmware;
                }
                document.getElementById(`firmware-short-${deviceName}`).textContent = shortFirmware;

            } else {
                throw new Error(data.error || 'El dispositivo reportó un error');
            } 
        } catch (error) {
            card.classList.add('status-offline');
            statusIcon.classList.remove('pending');
            statusIcon.classList.add('offline');
            card.querySelector('.card-body').innerHTML = `<p class="text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>${error.message}</p>`;
            card.querySelector('.card-footer').innerHTML = '';
        }
    };

    const showModal = (e) => {
        if (!e.target.classList.contains('info-button')) return;
        
        const deviceName = e.target.dataset.deviceName;
        const data = JSON.parse(e.target.dataset.deviceData);

        modalTitle.textContent = `Detalles de ${data.hostname || deviceName}`;
        
        let wifiClientsHtml = 'Ninguno';
        if (data.wifi_clients && data.wifi_clients !== 'Ninguno') {
            const clients = data.wifi_clients.split(',').map(c => c.trim());
            wifiClientsHtml = '<ul class="list-unstyled mb-0">';
            clients.forEach(client => {
                if (client) wifiClientsHtml += `<li><i class="bi bi-reception-4 me-2"></i>${client}</li>`;
            });
            wifiClientsHtml += '</ul>';
        }

        modalBody.innerHTML = `
            <h5><i class="bi bi-info-square-fill me-2"></i>Sistema</h5>
            <dl class="info-list">
                <dt>Hostname</dt><dd>${data.hostname || 'N/A'}</dd>
                <dt>Modelo</dt><dd>${data.model || 'N/A'}</dd>
                <dt>Arquitectura</dt><dd>${data.architecture || 'N/A'}</dd>
                <dt>Versión Firmware</dt><dd>${data.firmware || 'N/A'}</dd>
                <dt>Versión Kernel</dt><dd>${data.kernel_version || 'N/A'}</dd>
            </dl>

            <h5><i class="bi bi-activity me-2"></i>Estado</h5>
            <dl class="info-list">
                <dt>Hora Local</dt><dd>${data.local_time || 'N/A'}</dd>
                <dt>Uptime</dt><dd>${data.uptime || 'N/A'}</dd>
                <dt>Carga Media</dt><dd>${data.loadavg || 'N/A'}</dd>
                <dt>Uso de Memoria</dt><dd>${data.mem_free || 'N/A'} de ${data.mem_total || 'N/A'} libres</dd>
                <dt>Uso de Disco</dt><dd>${data.diskusage || 'N/A'}</dd>
            </dl>

            <h5><i class="bi bi-wifi me-2"></i>Red</h5>
            <dl class="info-list">
                <dt>IP</dt><dd>${data.ip || 'N/A'}</dd>
                <dt>Gateway</dt><dd>${data.gateway || 'N/A'}</dd>
                <dt>IP WAN</dt><dd>${data.wan_ip || 'N/A'}</dd>
                <dt>SSIDs</dt><dd>${data.ssids ? data.ssids.replace(/'/g, '') : 'N/A'}</dd>
                <dt>Clientes WiFi</dt><dd>${wifiClientsHtml}</dd>
            </dl>

            <h5><i class="bi bi-terminal-fill me-2"></i>Log del Sistema</h5>
            <div class="dmesg-log">${data.dmesg ? data.dmesg.replace(/\n/g, '<br>') : 'N/A'}</div>
        `;
        infoModal.show();
    };

    const loadAllDevices = async () => {
        container.innerHTML = '';
        try {
            const response = await fetch('/api/devices');
            const deviceNames = await response.json();
            if (deviceNames.length === 0) {
                container.innerHTML = '<p>No se encontraron dispositivos en el inventario.</p>';
                return;
            }
            deviceNames.forEach(name => container.appendChild(createDeviceCard(name)));
            deviceNames.forEach(name => updateCardStatus(name));
        } catch (error) {
            container.innerHTML = '<p>Error al cargar la lista de dispositivos.</p>';
        }
    };

    refreshButton.addEventListener('click', loadAllDevices);
    container.addEventListener('click', showModal);

    loadAllDevices();
});
</script>
{% endblock %}
