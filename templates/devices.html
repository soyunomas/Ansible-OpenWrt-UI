{% extends "layout.html" %}

{% block content %}
<style>
  /* --- Estilos Generales de la Tarjeta --- */
  .cards-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; }
  .card { border: 1px solid #ccc; border-radius: 8px; padding: 16px; width: 320px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-color: #f9f9f9; position: relative; transition: all 0.3s ease; display: flex; flex-direction: column; }
  .card.status-offline { background-color: #fff0f0; border-color: #e9a0a0; }
  .card.status-untrusted { background-color: #fff8e1; border-color: #ffc107; }
  .card h3 { margin-top: 0; padding-bottom: 10px; display: flex; align-items: center; font-size: 1.1rem; border-bottom: 1px solid #eee; margin-bottom: 1rem;}
  .card .card-body { flex-grow: 1; }
  .card .card-footer { font-size: 0.9rem; color: #6c757d; border-top: 1px solid #eee; padding-top: 10px; margin-top: auto; }
  
  /* --- Estilos para la Lista de Información (en tarjetas) --- */
  .info-list { font-size: 0.9rem; margin-bottom: 0; }
  .info-list dt { font-weight: bold; color: #0d6efd; font-size: 0.75rem; text-transform: uppercase; margin-top: 0.5rem; }
  .info-list dd { font-weight: 500; margin-left: 0; margin-bottom: 0.8rem; word-wrap: break-word; }
  .radio-badge { font-size: 0.8rem; }

  /* --- Iconos y Estados --- */
  .status-icon { width: 15px; height: 15px; border-radius: 50%; margin-right: 10px; display: inline-block; flex-shrink: 0;}
  .status-icon.pending { background-color: #ccc; animation: pulse 1.5s infinite; }
  .status-icon.online { background-color: #28a745; }
  .status-icon.offline { background-color: #dc3545; }
  #refresh-button { margin-bottom: 20px; }
  .info-button { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 1.2rem; }
  
  /* --- Estilos para el Modal --- */
  .modal-body .info-block { margin-bottom: 0.5rem; }
  .modal-body .info-block .label { font-size: 0.8rem; color: #6c757d; display: block; margin-bottom: -2px; }
  .modal-body .info-block .value { font-size: 0.95rem; font-weight: 600; word-wrap: break-word; display: flex; align-items: center; }
  .modal-body .info-block .value i { margin-right: 8px; font-size: 1.1rem; color: #0d6efd; }
  .modal-body h5 { color: #0d6efd; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-top: 1rem; margin-bottom: 1rem; }
  .modal-body h5:first-child { margin-top: 0; }
  .dmesg-log { background-color: #212529; color: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
  .output-console { background-color: #212529; color: #f8f9fa; padding: 1rem; border-radius: 0.25rem; max-height: 60vh; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
  @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
</style>

<div class="d-flex justify-content-between align-items-center">
    <h2>Estado de los Dispositivos</h2>
    <button id="refresh-button" class="btn btn-primary"><i class="bi bi-arrow-clockwise"></i> Refrescar</button>
</div>

<div id="cards-container" class="cards-container"></div>

<!-- Modals (Sin cambios aquí) -->
<div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="infoModalLabel">Detalles</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div></div>
<div class="modal fade" id="errorModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title" id="errorModalLabel">Error</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Falló la ejecución. Salida completa:</p><pre class="output-console" id="error-output-content"></pre></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div></div>
<div class="modal fade" id="trustHostModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title" id="trustHostModalLabel">Verificación Requerida</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Conexión no segura con <strong id="trust-host-name"></strong>.</p><p>Confirma que confías en esta huella SSH:</p><pre class="output-console" id="trust-host-fingerprint"></pre></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-warning" id="confirm-trust-button">Confiar</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('cards-container');
    const refreshButton = document.getElementById('refresh-button');
    // ... (resto de referencias a modals sin cambios)

    function escapeHTML(str) {
        return str ? String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]) : '';
    }

    /**
     * Devuelve el estándar 802.11 correspondiente a una generación de Wi-Fi.
     */
    function getWifiStandard(gen) {
        const standards = {
            'Wi-Fi 7': '802.11be', 'Wi-Fi 6': '802.11ax', 'Wi-Fi 5': '802.11ac',
            'Wi-Fi 4': '802.11n',  'Wi-Fi 3': '802.11g',  'Wi-Fi 2': '802.11a', 'Legacy': '802.11b'
        };
        return standards[gen] || '';
    }

    const createDeviceCard = (deviceName) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${deviceName}`;
        card.innerHTML = `
            <i class="bi bi-info-circle-fill info-button" data-device-name="${escapeHTML(deviceName)}" style="display: none;"></i>
            <h3><span id="status-icon-${deviceName}" class="status-icon pending"></span>${escapeHTML(deviceName)}</h3>
            <div class="card-body">
                <dl class="info-list">
                    <dt>Hostname</dt>
                    <dd id="hostname-${deviceName}">Cargando...</dd>
                    <dt>Modelo</dt>
                    <dd id="model-${deviceName}">Cargando...</dd>
                    <dt>Firmware</dt>
                    <dd id="firmware-short-${deviceName}">Cargando...</dd>
                </dl>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <span><strong>IP:</strong> <span id="ip-${deviceName}">Cargando...</span></span>
                <button class="btn btn-sm btn-outline-danger error-button" style="display: none;" data-device-name="${escapeHTML(deviceName)}">
                    <i class="bi bi-bug-fill"></i> Ver Error
                </button>
            </div>
        `;
        return card;
    };

    const updateCardStatus = async (deviceName) => {
        const card = document.getElementById(`card-${deviceName}`);
        // ... (resto de la función igual hasta la sección de 'online')
        try {
            const response = await fetch(`/api/status/${deviceName}`);
            const data = await response.json();
            if (!response.ok) throw new Error(JSON.stringify(data));

            const statusIcon = card.querySelector(`#status-icon-${deviceName}`);
            statusIcon.className = 'status-icon';
            card.classList.remove('status-offline', 'status-untrusted', 'status-online');
            
            card.querySelector('.card-body').innerHTML = `
                <dl class="info-list">
                    <dt>Hostname</dt> <dd id="hostname-${deviceName}">...</dd>
                    <dt>Modelo</dt> <dd id="model-${deviceName}">...</dd>
                    <dt>Firmware</dt> <dd id="firmware-short-${deviceName}">...</dd>
                </dl>`;
            
            if (data.status === 'online') {
                statusIcon.classList.add('online');
                card.classList.add('status-online');
                card.querySelector('.info-button').style.display = 'block';
                card.querySelector('.info-button').dataset.deviceData = JSON.stringify(data);
                
                card.querySelector(`#hostname-${deviceName}`).textContent = data.hostname || 'N/A';
                card.querySelector(`#model-${deviceName}`).textContent = data.model || 'N/A';
                card.querySelector(`#firmware-short-${deviceName}`).textContent = data.firmware ? (data.firmware.match(/^(.*?)\s*r\d+/)?.[1].trim() || data.firmware) : 'N/A';
                card.querySelector(`#ip-${deviceName}`).textContent = data.interfaces?.[0]?.ip || 'N/A';

                // --- INICIO DE LA MODIFICACIÓN ---
                let radioHtml = '<span class="text-muted small">No radios</span>';
                if (data.radios && data.radios.length > 0) {
                    radioHtml = data.radios.map(r => {
                        const standard = getWifiStandard(r.generation);
                        // Formato: "radio0 (802.11n - Wi-Fi 4)"
                        const displayText = standard ? 
                            `${escapeHTML(r.name)} (${escapeHTML(standard)} - ${escapeHTML(r.generation)})` : 
                            `${escapeHTML(r.name)} (${escapeHTML(r.generation)})`;
                        return `<div class="radio-badge">${displayText}</div>`;
                    }).join('');
                }
                
                card.querySelector('.card-body dl.info-list').innerHTML += `
                    <dt>WIFI</dt>
                    <dd>${radioHtml}</dd>
                `;
                // --- FIN DE LA MODIFICACIÓN ---

            } else if (data.status === 'untrusted_host') {
                // ... (lógica de untrusted_host sin cambios)
            } else {
                throw new Error(JSON.stringify(data));
            }
        } catch (error) {
            // ... (lógica de error sin cambios)
        }
    };

    // El resto de las funciones JS (showModal, showErrorModal, etc.) no necesitan cambios.
    // Asegúrate de que estén presentes como en las versiones anteriores.
    // ...
    const loadAllDevices = async () => {
        container.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';
        try {
            const response = await fetch('/api/devices');
            const deviceNames = await response.json();
            container.innerHTML = '';
            if (!deviceNames.length) { container.innerHTML = '<p>No hay dispositivos.</p>'; return; }
            deviceNames.forEach(name => container.appendChild(createDeviceCard(name)));
            deviceNames.forEach(name => updateCardStatus(name));
        } catch (error) {
            container.innerHTML = '<p class="text-danger">Error al cargar dispositivos.</p>';
        }
    };
    refreshButton.addEventListener('click', loadAllDevices);
    // ... (event listeners)
    loadAllDevices();
});
</script>
{% endblock %}
